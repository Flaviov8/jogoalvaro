<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Space ‚Äî D-Pad + Mestre Carolina Manca (com Itens Raros)</title>
<style>
  :root{--bg:#020814;--panel:rgba(255,255,255,0.04);--accent:#3ee7b6}
  html,body{height:100%;margin:0;background:var(--bg);font-family:Inter,system-ui,Arial;color:#e6eef1;-webkit-tap-highlight-color: transparent}
  #wrap{position:relative;width:100vw;height:100vh;overflow:hidden}
  canvas{display:block;width:100%;height:100%;touch-action:none}
  #ui{position:absolute;left:12px;top:12px;z-index:60;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .pill{background:var(--panel);padding:8px 10px;border-radius:10px;font-weight:700;backdrop-filter:blur(6px);font-size:14px}
  #rightPanel{position:absolute;right:12px;top:12px;z-index:60;text-align:right}
  button.primary{appearance:none;border:0;background:linear-gradient(90deg,var(--accent),#7be7d0);color:#04221a;padding:8px 12px;border-radius:10px;font-weight:800;cursor:pointer}
  #overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;z-index:70}
  .menu{background:rgba(2,6,13,0.6);border-radius:12px;padding:18px;width:320px;text-align:center;box-shadow:0 8px 40px rgba(2,6,23,0.6)}
  .small{font-size:13px;color:#a8bac2}

  /* D-PAD circular control (mobile) */
  #dpad{position:fixed;left:12px;bottom:12px;width:170px;height:170px;border-radius:50%;background:radial-gradient(circle at 30% 30%, rgba(255,255,255,0.03), rgba(255,255,255,0.01));display:none;align-items:center;justify-content:center;z-index:130;box-shadow:0 6px 20px rgba(0,0,0,0.6)}
  .dbtn{position:absolute;width:56px;height:56px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,0.06);color:#fff;font-weight:800;touch-action:none;user-select:none}
  .d-up{top:12%;left:50%;transform:translateX(-50%)}
  .d-down{bottom:12%;left:50%;transform:translateX(-50%)}
  .d-left{left:12%;top:50%;transform:translateY(-50%)}
  .d-right{right:12%;top:50%;transform:translateY(-50%)}
  .d-fire{right:-18%;bottom:50%;width:72px;height:72px;background:linear-gradient(90deg,var(--accent),#7be7d0);color:#04221a}

  @media (max-width: 880px){ #dpad{display:flex} }
  @media (min-width: 880px){ #dpad{display:none} }

  /* responsive hit area tweak for small devices */
  @media (max-width:420px){ #dpad{width:200px;height:200px} .dbtn{width:64px;height:64px} }

  /* subtle shake when explosion */
  .shake{animation:shake 600ms ease-in-out}
  @keyframes shake{0%{transform:translate(0,0)}25%{transform:translate(8px,-6px)}50%{transform:translate(-6px,6px)}75%{transform:translate(6px,-4px)}100%{transform:translate(0,0)} }
</style>
</head>
<body>
<div id="wrap">
  <canvas id="c" aria-label="√Årea do jogo"></canvas>

  <div id="ui">
    <div class="pill">Vidas: <span id="vidas">3</span></div>
    <div class="pill">Score: <span id="score">0</span></div>
    <div class="pill">Destruidos: <span id="killed">0</span></div>
    <div class="pill">Arma: <span id="weaponLevel">1</span></div>
    <div class="pill">Itens Raros: <span id="rareCount">0</span></div>
  </div>

  <div id="rightPanel">
    <div class="pill small">Fase: <span id="fase">1</span></div>
    <div style="height:8px"></div>
    <button id="muteBtn" class="primary">Som</button>
  </div>

  <div id="overlay">
    <div class="menu" id="menuStart">
      <h2>üöÄ Space ‚Äî 10 Fases</h2>
      <p class="small">Movimente: ‚Üê ‚Üí ‚Üë ‚Üì (teclado) ou use o D-Pad. Atirar: Espa√ßo / bot√£o.</p>
      <div style="height:12px"></div>
      <button id="startBtn" class="primary">Iniciar</button>
      <div style="height:8px"></div>
      <p class="small">Carregue sua nave (opcional) ‚Äî ou coloque <code>alvaro2.png</code> na mesma pasta</p>
      <input id="imgInput" type="file" accept="image/*" style="width:100%" />
    </div>
    <div class="menu" id="menuOver" style="display:none">
      <h2 id="overTitle">Game Over</h2>
      <p id="overScore" class="small">Score: 0</p>
      <div style="height:8px"></div>
      <button id="restartBtn" class="primary">Reiniciar</button>
    </div>
  </div>

  <!-- circular D-Pad -->
  <div id="dpad" aria-hidden="false">
    <div class="dbtn d-up" id="dbUp">‚ñ≤</div>
    <div class="dbtn d-left" id="dbLeft">‚óÄ</div>
    <div class="dbtn d-right" id="dbRight">‚ñ∂</div>
    <div class="dbtn d-down" id="dbDown">‚ñº</div>
    <div class="dbtn d-fire" id="dbFire">üî´</div>
  </div>
</div>

<script>
(() => {
  const canvas = document.getElementById('c');
  const ctx = canvas.getContext('2d');
  let DPR = Math.max(1, window.devicePixelRatio || 1);
  function resize(){ canvas.width = Math.floor(window.innerWidth * DPR); canvas.height = Math.floor(window.innerHeight * DPR); ctx.setTransform(DPR,0,0,DPR,0,0); }
  window.addEventListener('resize', resize); resize();

  // DOM refs
  const vidasEl = document.getElementById('vidas');
  const scoreEl = document.getElementById('score');
  const killedEl = document.getElementById('killed');
  const faseEl = document.getElementById('fase');
  const weaponEl = document.getElementById('weaponLevel');
  const rareCountEl = document.getElementById('rareCount');
  const startBtn = document.getElementById('startBtn');
  const restartBtn = document.getElementById('restartBtn');
  const menuStart = document.getElementById('menuStart');
  const menuOver = document.getElementById('menuOver');
  const overScore = document.getElementById('overScore');
  const imgInput = document.getElementById('imgInput');
  const muteBtn = document.getElementById('muteBtn');

  // dpad buttons
  const dbUp = document.getElementById('dbUp');
  const dbDown = document.getElementById('dbDown');
  const dbLeft = document.getElementById('dbLeft');
  const dbRight = document.getElementById('dbRight');
  const dbFire = document.getElementById('dbFire');

  // game state
  let running=false, score=0, killed=0, fase=1, vidas=3;
  let enemies = [], bullets = [], particles = [], boss = null;

  // powerups & weapons
  let powerups = []; // {x,y,w,h,vy,type,rare}
  let weaponLevel = 1;  // 1..5
  const MAX_WEAPON = 5;

  // player + inventory
  const playerImg = new Image(); playerImg.src = 'alvaro2.png'; let playerLoaded=false; playerImg.onload = ()=> playerLoaded=true;
  const player = { w:64,h:64,x:0,y:0,speed:520, alive:true, inventory: [] };

  function centerPlayer(){ const W = canvas.width/DPR, H = canvas.height/DPR; player.x = Math.floor((W - player.w)/2); player.y = Math.floor(H - player.h - 60); }

  // enemy image
  const enemyImg = new Image(); enemyImg.src = 'flavioinimigo.png'; let enemyLoaded = false; enemyImg.onload = ()=> enemyLoaded = true;

  // stars
  const stars = []; function initStars(){ stars.length=0; const count = Math.min(400, Math.floor((window.innerWidth*window.innerHeight)/4000)); for(let i=0;i<count;i++) stars.push({x:Math.random()*window.innerWidth, y:Math.random()*window.innerHeight, r:Math.random()*1.6+0.2, s:Math.random()*0.6+0.2}); }
  initStars(); window.addEventListener('resize', ()=>{ initStars(); resize(); });
  function updateStars(dt){ for(const s of stars){ s.y += s.s * 60 * dt; if(s.y > window.innerHeight){ s.y = -2; s.x = Math.random()*window.innerWidth; } } }
  function drawStars(){ ctx.fillStyle = '#bfe7ff'; for(const s of stars) ctx.fillRect(s.x, s.y, s.r, s.r); }

  // audio
  let audioCtx=null; try{ audioCtx = new (window.AudioContext||window.webkitAudioContext)(); }catch(e){ audioCtx=null; }
  let muted = false; muteBtn.onclick = ()=>{ muted = !muted; muteBtn.textContent = muted? 'Som Off':'Som'; };
  function sfxExplosion(){ if(!audioCtx || muted) return; const o = audioCtx.createOscillator(); const g = audioCtx.createGain(); o.type='sawtooth'; o.frequency.value = 80 + Math.random()*120; g.gain.value = 0.12; o.connect(g); g.connect(audioCtx.destination); o.start(); g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.35); o.stop(audioCtx.currentTime + 0.36); }
  function sfxShoot(){ if(!audioCtx || muted) return; const o = audioCtx.createOscillator(); const g = audioCtx.createGain(); o.type='square'; o.frequency.value = 1100; g.gain.value = 0.06; o.connect(g); g.connect(audioCtx.destination); o.start(); g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.06); o.stop(audioCtx.currentTime + 0.07); }
  function sfxPower(){ if(!audioCtx || muted) return; const o = audioCtx.createOscillator(); const g = audioCtx.createGain(); o.type='triangle'; o.frequency.value = 600; g.gain.value = 0.08; o.connect(g); g.connect(audioCtx.destination); o.start(); g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.18); o.stop(audioCtx.currentTime + 0.19); }

  // helpers
  const rand = (a,b)=> a + Math.random()*(b-a);
  function rects(a,b){ return a.x < b.x + b.w && a.x + a.w > b.x && a.y < b.y + b.h && a.y + a.h > b.y; }

  // spawn enemies
  function spawnEnemies(){ enemies = []; const W = canvas.width/DPR; const count = Math.min(14, 4 + Math.floor(fase*1.2)); for(let i=0;i<count;i++){ enemies.push({ x: rand(20, W-68), y: rand(-800, -40), w:56, h:56, vy: rand(40, 80) + fase*8, hp: Math.max(1, Math.ceil(1 + fase*0.25)), alive:true, id:i }); } }

  // bullets
  let lastShot=0;
  function shoot(){
    if(!player.alive) return;
    const now = performance.now();
    if(now - lastShot < 140) return;
    lastShot = now;
    sfxShoot();

    const cx = player.x + player.w/2;

    switch(weaponLevel) {
      case 1:
        bullets.push({ x: cx-6, y: player.y-10, w:12, h:20, vy:-860, dmg:1 });
        break;
      case 2:
        bullets.push({ x: cx-20, y: player.y-10, w:12, h:20, vy:-860, dmg:1 });
        bullets.push({ x: cx+8,  y: player.y-10, w:12, h:20, vy:-860, dmg:1 });
        break;
      case 3:
        bullets.push({ x: cx-6,  y: player.y-10, w:12, h:20, vy:-860, dmg:1 });
        bullets.push({ x: cx-26, y: player.y-6,  w:12, h:20, vy:-840, dmg:1 });
        bullets.push({ x: cx+14, y: player.y-6,  w:12, h:20, vy:-840, dmg:1 });
        break;
      case 4:
        bullets.push({ x: cx-6,  y: player.y-12, w:12, h:20, vy:-860, dmg:1 });
        bullets.push({ x: cx+12, y: player.y-8,  w:12, h:20, vy:-840, dmg:1 });
        bullets.push({ x: cx-26, y: player.y-8,  w:12, h:20, vy:-840, dmg:1 });
        bullets.push({ x: cx+32, y: player.y-6,  w:12, h:20, vy:-820, dmg:1 });
        break;
      case 5:
        bullets.push({ x: cx-4, y: player.y-20, w:8, h:40, vy:-1200, dmg:2 });
        break;
      default:
        bullets.push({ x: cx-6, y: player.y-10, w:12, h:20, vy:-860, dmg:1 });
    }
  }

  // explosion particles
  function spawnExplosion(x,y,amount=22){
    sfxExplosion();
    for(let i=0;i<amount;i++){
      const ang = rand(0,Math.PI*2);
      const sp = rand(80,360);
      particles.push({ x, y, vx:Math.cos(ang)*sp, vy:Math.sin(ang)*sp, life:0.6+Math.random()*0.6, r:1+Math.random()*3 });
    }
  }

  // load custom player image
  imgInput.addEventListener('change', e=>{
    const f = e.target.files && e.target.files[0];
    if(!f) return;
    const r = new FileReader();
    r.onload = ()=> { playerImg.src = r.result; playerLoaded = false; playerImg.onload = ()=> playerLoaded = true; };
    r.readAsDataURL(f);
  });

  // D-Pad touch handling (pointer + touch + mouse)
  const touchState = { up:false, down:false, left:false, right:false, shoot:false };
  function bindDbtn(el, key){ if(!el) return; el.addEventListener('pointerdown', e=>{ e.preventDefault(); touchState[key]=true; el.classList.add('active'); }, {passive:false}); el.addEventListener('pointerup', e=>{ e.preventDefault(); touchState[key]=false; el.classList.remove('active'); }, {passive:false}); el.addEventListener('pointercancel', ()=>{ touchState[key]=false; el.classList.remove('active'); }); el.addEventListener('touchstart', e=>{ e.preventDefault(); touchState[key]=true; }, {passive:false}); el.addEventListener('touchend', e=>{ e.preventDefault(); touchState[key]=false; }, {passive:false}); el.addEventListener('mousedown', e=>{ e.preventDefault(); touchState[key]=true; }); el.addEventListener('mouseup', e=>{ e.preventDefault(); touchState[key]=false; }); }
  bindDbtn(dbUp,'up'); bindDbtn(dbDown,'down'); bindDbtn(dbLeft,'left'); bindDbtn(dbRight,'right'); bindDbtn(dbFire,'shoot');

  // keyboard
  const keys = {}; window.addEventListener('keydown', e=>{ keys[e.key.toLowerCase()]=true; if(e.code==='Space') e.preventDefault(); }); window.addEventListener('keyup', e=> keys[e.key.toLowerCase()]=false);

  // start/restart
  function start(){ if(!playerLoaded){ alert('A imagem da nave ainda est√° carregando ‚Äî tente novamente em 1s'); return; } running=true; score=0; killed=0; fase=1; vidas=3; player.alive=true; weaponLevel = 1; player.inventory = []; powerups = []; updateUI(); centerPlayer(); spawnEnemies(); menuStart.style.display='none'; menuOver.style.display='none'; last = performance.now(); requestAnimationFrame(loop); }
  startBtn.addEventListener('click', start);
  restartBtn.addEventListener('click', ()=> location.reload());

  function updateUI(){ vidasEl.textContent = vidas; scoreEl.textContent = score; killedEl.textContent = killed; faseEl.textContent = fase; weaponEl.textContent = weaponLevel; rareCountEl.textContent = player.inventory.length; }

  // boss (mestre) spawn
  function spawnMestre(){
    boss = {
      x: (canvas.width/DPR - 420)/2,
      y: 40,
      w:420,
      h:220,
      hp: 180 + Math.floor(Math.random()*60),
      name: 'Carolina Manca',
      mestre: true,
      vx: 0
    };
    // create some pre-boss particles / sound
    sfxPower();
  }

  // powerup spawn helper (called when enemy dies)
  function spawnPowerUp(x,y, forcedType){
    // types:
    // - 'weapon' (comum) : aumenta weaponLevel (tempor√°rio until death? but collected persists)
    // - 'rare' : raro, adiciona ao inventory e confere b√¥nus permanente
    // - 'life' : +1 vida (uncommon)
    // If forcedType provided, use it
    let type = forcedType || 'weapon';
    // chance override: if not forced, randomly decide rarity
    if(!forcedType){
      const r = Math.random();
      if(r < 0.05) type = 'rare';        // 5% rare
      else if(r < 0.12) type = 'life';   // 7% life
      else type = 'weapon';              // rest common
    }

    const pu = { x: x - 14, y: y - 14, w: 28, h: 28, vy: 120, type: type, id: Math.random().toString(36).slice(2,9) };
    // mark rare visuals
    if(type === 'rare') pu.rare = true;
    powerups.push(pu);
    return pu;
  }

  // main loop
  let last = performance.now();
  function loop(now){
    const dt = Math.min(0.033, (now - last)/1000);
    last = now;
    if(!running) return;

    // input (keyboard + dpad)
    if(keys['arrowleft']||keys['a']||touchState.left) player.x -= player.speed * dt;
    if(keys['arrowright']||keys['d']||touchState.right) player.x += player.speed * dt;
    if(keys['arrowup']||keys['w']||touchState.up) player.y -= player.speed * dt;
    if(keys['arrowdown']||keys['s']||touchState.down) player.y += player.speed * dt;
    if((keys[' ']||keys['space']||touchState.shoot)) shoot();

    const W = canvas.width/DPR, H = canvas.height/DPR;
    player.x = Math.max(8, Math.min(player.x, W - player.w - 8));
    player.y = Math.max(8, Math.min(player.y, H - player.h - 8));

    // update stars
    updateStars(dt);

    // update bullets
    for(let i=bullets.length-1;i>=0;i--){
      const b = bullets[i];
      b.y += b.vy * dt;
      if(b.y + b.h < -40) bullets.splice(i,1);
    }

    // update enemies
    for(let i=enemies.length-1;i>=0;i--){
      const e = enemies[i];
      if(!e.alive) continue;
      e.y += e.vy * dt;
      e.x += Math.sin((e.y+e.id)*0.02) * 18 * dt;
      e.vy += 6 * dt;
      if(e.y > H + 120){
        e.y = -rand(40, 260);
        e.x = rand(20, W-80);
        e.vy = rand(40,80) + fase*6;
      }
      if(rects(e, player)){
        e.alive=false;
        spawnExplosion(player.x+player.w/2, player.y+player.h/2, 28);
        vidas--;
        updateUI();
        if(vidas<=0){ playerDie(); }
      }
    }

    // bullets vs enemies
    for(let i=enemies.length-1;i>=0;i--){
      const e = enemies[i];
      if(!e.alive) continue;
      for(let j=bullets.length-1;j>=0;j--){
        const b = bullets[j];
        if(rects(b,e)){
          bullets.splice(j,1);
          e.hp -= (b.dmg || 1);
          if(e.hp <= 0){
            e.alive = false;
            killed++;
            score += 10 + Math.floor(fase*2);
            spawnExplosion(e.x+e.w/2,e.y+e.h/2, 22);
            // chance to drop powerup:
            // 5% rare, 7% life, 8% weapon (so total ~20%)
            const r = Math.random();
            if(r < 0.05){
              spawnPowerUp(e.x + e.w/2, e.y + e.h/2, 'rare');
            } else if(r < 0.12){
              spawnPowerUp(e.x + e.w/2, e.y + e.h/2, 'life');
            } else if(r < 0.2){
              spawnPowerUp(e.x + e.w/2, e.y + e.h/2, 'weapon');
            }
            updateUI();
          } else {
            score += 2;
            updateUI();
          }
          break;
        }
      }
    }

    // phase progression logic:
    // clear enemies -> if fase < 9 -> advance to next normal phase
    // if fase === 9 and cleared -> spawn boss (mestre) as phase 10
    // if fase === 10 and boss dead -> win handled in boss logic
    const aliveEnemies = enemies.some(e=>e.alive);
    if(!aliveEnemies && !boss){
      if(fase < 9){
        fase++;
        updateUI();
        spawnEnemies();
      } else if(fase === 9){
        // next is final boss (mestre)
        fase = 10;
        updateUI();
        spawnMestre();
      }
    }

    // boss (mestre) handling
    if(boss){
      // simple horizontal patrol
      boss.x += Math.sin(performance.now()*0.0007) * 60 * dt;
      // boss collision with bullets
      for(let j=bullets.length-1;j>=0;j--){
        const b = bullets[j];
        if(rects(b,boss)){
          bullets.splice(j,1);
          boss.hp -= (b.dmg || 1);
          spawnExplosion(b.x,b.y,8);
          if(boss.hp<=0){
            // big explosion for mestre
            spawnExplosion(boss.x+boss.w/2,boss.y+boss.h/2,160);
            // drop several rare items when mestre dies
            for(let k=0;k<4;k++){
              spawnPowerUp(boss.x + boss.w*(0.15 + 0.2*k), boss.y + boss.h/2, 'rare');
            }
            score += 1000;
            updateUI();
            // mark boss as defeated and win after short delay
            const defeatedName = boss.name || 'Mestre';
            boss = null;
            setTimeout(()=> {
              win(`${defeatedName} foi derrotada!`);
            }, 400);
          }
        }
      }
    }

    // update powerups (they persist across phases if not collected)
    for (let i = powerups.length - 1; i >= 0; i--) {
      const p = powerups[i];
      p.y += p.vy * dt;

      // collect by player
      if (rects(player, p)) {
        if (p.type === 'weapon') {
          // weapon upgrade: increase weaponLevel up to MAX_WEAPON and persist across phases
          weaponLevel++;
          if (weaponLevel > MAX_WEAPON) weaponLevel = MAX_WEAPON;
          sfxPower();
        } else if (p.type === 'life') {
          vidas++;
          sfxPower();
        } else if (p.type === 'rare') {
          // rare: goes into player's inventory and grants a permanent bonus
          player.inventory.push({ id: p.id, name: 'Rel√≠quia Rara', bonus: 'arma+' + 1 });
          // grant a permanent max weapon increase (example)
          if (MAX_WEAPON < 6) {} // keep compatibility - not changing constant
          // optionally increment weaponLevel (permanent boost)
          weaponLevel = Math.min(MAX_WEAPON, weaponLevel + 1);
          sfxPower();
        }
        powerups.splice(i, 1);
        updateUI();
        continue;
      }

      // if go off screen, keep them removed to avoid infinite memory leak
      if (p.y > H + 200) powerups.splice(i, 1);
    }

    // update particles
    for(let i=particles.length-1;i>=0;i--){
      const p = particles[i];
      p.x += p.vx * dt;
      p.y += p.vy * dt;
      p.life -= dt;
      p.r += 0.4;
      if(p.life <= 0) particles.splice(i,1);
    }

    draw();
    requestAnimationFrame(loop);
  }

  function playerDie(){
    player.alive = false;
    spawnExplosion(player.x + player.w/2, player.y + player.h/2, 96);
    const wrap = document.getElementById('wrap'); wrap.classList.add('shake'); setTimeout(()=> wrap.classList.remove('shake'), 700);
    sfxExplosion();
    playerLoaded = false;
    running = false;
    setTimeout(()=>{
      document.getElementById('overTitle').innerText = 'Game Over';
      overScore.innerText = 'Score: ' + score;
      menuOver.style.display = 'block';
    }, 800);
  }

  function gameOver(){ running=false; menuOver.style.display='none'; document.getElementById('overTitle').innerText = 'Game Over'; overScore.innerText = 'Score: ' + score; menuOver.style.display='block'; }
  function win(message){
    running=false;
    menuOver.style.display='none';
    document.getElementById('overTitle').innerText = message ? message : 'Voc√™ venceu!';
    overScore.innerText = 'Score: ' + score;
    menuOver.style.display='block';
  }

  // draw
  function draw(){
    const W = canvas.width/DPR, H = canvas.height/DPR;
    ctx.clearRect(0,0,canvas.width,canvas.height);
    // backdrop
    const g = ctx.createLinearGradient(0,0,0,H); g.addColorStop(0,'#001021'); g.addColorStop(1,'#00030a'); ctx.fillStyle = g; ctx.fillRect(0,0,W,H);
    drawStars();

    // bullets
    ctx.fillStyle = '#ffd880';
    for(const b of bullets){
      ctx.fillRect(b.x,b.y,b.w,b.h);
    }

    // enemies
    for(const e of enemies){
      if(!e.alive) continue;
      if(enemyLoaded){
        ctx.drawImage(enemyImg, e.x, e.y, e.w, e.h);
      } else {
        ctx.fillStyle='#ff6b6b';
        ctx.fillRect(e.x,e.y,e.w,e.h);
      }
      // small HP bar
      ctx.fillStyle = 'rgba(0,0,0,0.6)';
      ctx.fillRect(e.x, e.y-6, e.w, 4);
      ctx.fillStyle = '#ffcc66';
      const baseHp = Math.max(1, Math.ceil(1 + fase*0.25));
      const hpPerc = Math.max(0, e.hp) / baseHp;
      ctx.fillRect(e.x, e.y-6, e.w * hpPerc, 4);
    }

    // boss (mestre)
    if(boss){
      ctx.fillStyle = '#c13cff';
      ctx.fillRect(boss.x, boss.y, boss.w, boss.h);
      ctx.fillStyle = '#fff';
      ctx.font = '20px Inter';
      ctx.fillText(boss.name + ' (Mestre)', boss.x + 12, boss.y + 28);
      ctx.fillText('HP: ' + boss.hp, boss.x + 12, boss.y + 52);
      // boss aura
      ctx.beginPath();
      ctx.strokeStyle = 'rgba(193,60,255,0.12)';
      ctx.lineWidth = 8;
      ctx.strokeRect(boss.x-6, boss.y-6, boss.w+12, boss.h+12);
      ctx.lineWidth = 1;
      ctx.strokeStyle = '#000';
    }

    // powerups (persist until collected)
    for (const p of powerups) {
      if(p.rare){
        // rare visual
        ctx.fillStyle = '#ffd700';
        ctx.beginPath();
        ctx.arc(p.x + p.w/2, p.y + p.h/2, 16, 0, Math.PI*2);
        ctx.fill();
        ctx.fillStyle = '#331a00';
        ctx.font = '16px Inter';
        ctx.fillText('‚òÖ', p.x + 6, p.y + 22);
      } else if(p.type === 'life'){
        ctx.fillStyle = '#ff7b7b';
        ctx.beginPath();
        ctx.arc(p.x + p.w/2, p.y + p.h/2, 14, 0, Math.PI*2);
        ctx.fill();
        ctx.fillStyle = '#fff';
        ctx.font = '14px Inter';
        ctx.fillText('+', p.x + 8, p.y + 21);
      } else {
        ctx.fillStyle = '#3ee7b6';
        ctx.beginPath();
        ctx.arc(p.x + p.w/2, p.y + p.h/2, 14, 0, Math.PI*2);
        ctx.fill();
        ctx.fillStyle = '#04221a';
        ctx.font = '16px Inter';
        ctx.fillText('‚ö°', p.x + 6, p.y + 22);
      }
    }

    // player
    if(playerLoaded && player.alive) ctx.drawImage(playerImg, player.x, player.y, player.w, player.h);

    // particles
    for(const p of particles){
      ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,Math.PI*2);
      ctx.fillStyle = `rgba(255,160,80,${Math.max(0, p.life)})`; ctx.fill();
    }
  }

  // init
  function initPositions(){ centerPlayer(); spawnEnemies(); updateUI(); }
  initPositions();

  // mouse click to shoot
  window.addEventListener('mousedown', ()=> shoot());

})();
</script>
</body>
</html>
